<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador R√°pido de PDF</title>
    
    <!-- Biblioteca jsPDF - A abordagem que funciona! -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Biblioteca SortableJS para arrastar e soltar os itens -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 1000px; width: 100%; margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px; backdrop-filter: blur(10px);
        }
        
        .header h1 {
            text-align: center; color: #333; font-size: 2.2em; margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .header p { text-align: center; color: #666; font-size: 1.1em; margin-bottom: 30px; }
        
        .form-section {
            margin-bottom: 25px; padding: 20px; background: white;
            border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 5px solid #667eea;
        }
        .form-section h3 {
            color: #333; margin-bottom: 15px; font-size: 1.3em;
            padding-bottom: 10px; border-bottom: 1px solid #eee;
        }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; }
        input[type="text"], textarea {
            width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9;
            border-radius: 8px; font-size: 16px; transition: all 0.3s ease;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none; border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        textarea { resize: vertical; min-height: 100px; }
        
        .drop-zone {
            border: 3px dashed #667eea; border-radius: 15px; padding: 30px;
            text-align: center; background: #fafbff; transition: all 0.3s ease; cursor: pointer;
        }
        .drop-zone.drag-over { background: #f0f3ff; border-color: #764ba2; }
        .drop-zone-text { color: #667eea; font-size: 1.2em; font-weight: 600; }
        .drop-zone-subtext { color: #888; font-size: 0.9em; }
        
        .images-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        
        .image-item {
            position: relative; background: white; border-radius: 10px;
            padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease; border: 1px solid #eee;
        }
        .image-item:hover { transform: translateY(-3px); }
        .image-item img {
            width: 100%; height: auto; object-fit: contain;
            border-radius: 8px; background: #f8f9fa; margin-bottom: 10px;
        }
        
        .remove-btn, .drag-handle {
            position: absolute; top: 10px; background: rgba(0,0,0,0.5);
            color: white; border: none; border-radius: 50%;
            width: 28px; height: 28px; cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .remove-btn { right: 10px; }
        .drag-handle { left: 10px; cursor: move; }
        .remove-btn:hover { background: #ff3742; transform: scale(1.1); }
        .drag-handle:hover { background: #555; }
        
        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 15px 40px;
            font-size: 1.1em; font-weight: 600; border-radius: 50px;
            cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            display: block; margin: 30px auto 0;
        }
        .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6); }
        .generate-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .loading-message { display: none; text-align: center; color: #667eea; font-weight: 600; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div class="header">
            <h1>üìÑ Criador R√°pido de Documentos</h1>
            <p>Crie um PDF profissional em segundos. Cole (Ctrl+V) ou arraste suas imagens.</p>
        </div>
        
        <div id="report-builder">
            <div class="form-section">
                <h3>üìù Informa√ß√µes do Documento</h3>
                <div class="input-group">
                    <label for="titulo">T√≠tulo do Documento:</label>
                    <input type="text" id="titulo" placeholder="Ex: Relat√≥rio Mensal de Vendas">
                </div>
                <div class="input-group">
                    <label for="responsavel">Autor / Respons√°vel:</label>
                    <input type="text" id="responsavel" placeholder="Ex: Jo√£o da Silva">
                </div>
                <div class="input-group">
                    <label for="descricao">Descri√ß√£o / Observa√ß√µes:</label>
                    <textarea id="descricao" placeholder="Adicione aqui uma descri√ß√£o, resumo ou observa√ß√µes gerais."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h3>üì∏ Imagens Anexadas</h3>
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-text">Cole (Ctrl+V) ou Arraste as Imagens Aqui</div>
                    <div class="drop-zone-subtext">Voc√™ pode reorden√°-las depois</div>
                </div>
                <div class="images-container" id="imagesContainer"></div>
            </div>
        </div>
        
        <button class="generate-btn" id="generateBtn">üöÄ Gerar PDF</button>
        <div class="loading-message" id="loadingMessage">Gerando PDF... Por favor, aguarde.</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            const dropZone = document.getElementById('dropZone');
            const imagesContainer = document.getElementById('imagesContainer');
            const generateBtn = document.getElementById('generateBtn');
            const loadingMessage = document.getElementById('loadingMessage');

            new Sortable(imagesContainer, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost' });

            const handleFiles = (files) => {
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => createImageItem(e.target.result);
                        reader.readAsDataURL(file);
                    }
                }
            };

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
            document.addEventListener('paste', (e) => handleFiles(e.clipboardData.files));

            const createImageItem = (src) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'image-item';
                itemDiv.innerHTML = `
                    <div class="drag-handle" title="Arrastar para reordenar">‚ò∞</div>
                    <button class="remove-btn" title="Remover imagem">√ó</button>
                    <img src="${src}" alt="Captura de tela">
                    <input type="text" class="image-description" placeholder="Descri√ß√£o da imagem (opcional)">
                `;
                imagesContainer.appendChild(itemDiv);
                itemDiv.querySelector('.remove-btn').addEventListener('click', () => itemDiv.remove());
            };

            // --- L√ìGICA DE GERA√á√ÉO DE PDF RECONSTRU√çDA ---
            generateBtn.addEventListener('click', async () => {
                const imageItems = imagesContainer.querySelectorAll('.image-item');
                if (imageItems.length === 0) {
                    alert('Por favor, adicione pelo menos uma imagem antes de gerar o PDF.');
                    return;
                }

                generateBtn.disabled = true;
                loadingMessage.style.display = 'block';

                try {
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const page_width = pdf.internal.pageSize.getWidth();
                    const margin = 15;
                    let y_position = 20;

                    // Fun√ß√£o para adicionar texto e gerir a posi√ß√£o Y e quebras de p√°gina
                    const addText = (text, size, y, isBold = false) => {
                        pdf.setFontSize(size);
                        pdf.setFont('helvetica', isBold ? 'bold' : 'normal');
                        const splitText = pdf.splitTextToSize(text, page_width - margin * 2);
                        
                        if (y + (splitText.length * (size / 2)) > pdf.internal.pageSize.getHeight() - margin) {
                            pdf.addPage();
                            y = 20;
                        }
                        pdf.text(splitText, margin, y);
                        return y + (splitText.length * (size / 2.5)) + 5;
                    };

                    // Adicionar Cabe√ßalho
                    const titulo = document.getElementById('titulo').value || 'Documento Sem T√≠tulo';
                    const responsavel = document.getElementById('responsavel').value;
                    const descricao = document.getElementById('descricao').value;
                    const data = new Date().toLocaleDateString('pt-BR');

                    y_position = addText(titulo, 22, y_position, true);
                    if (responsavel) y_position = addText(`Autor: ${responsavel}`, 12, y_position);
                    y_position = addText(`Data: ${data}`, 12, y_position);
                    y_position += 5; // Espa√ßo extra
                    
                    if (descricao) {
                        y_position = addText('Observa√ß√µes Gerais:', 14, y_position, true);
                        y_position = addText(descricao, 12, y_position);
                    }
                    
                    // Adicionar Imagens
                    for (const item of imageItems) {
                        y_position += 10;
                        const imgElement = item.querySelector('img');
                        const imgDescription = item.querySelector('input').value;

                        // Adicionar descri√ß√£o da imagem
                        if (imgDescription) {
                            y_position = addText(imgDescription, 12, y_position, true);
                        }

                        // Calcular propor√ß√£o da imagem para n√£o distorcer
                        const img_width = imgElement.naturalWidth;
                        const img_height = imgElement.naturalHeight;
                        const ratio = img_width / img_height;
                        const pdf_img_width = page_width - margin * 2;
                        const pdf_img_height = pdf_img_width / ratio;

                        if (y_position + pdf_img_height > pdf.internal.pageSize.getHeight() - margin) {
                            pdf.addPage();
                            y_position = 20;
                        }

                        pdf.addImage(imgElement.src, 'JPEG', margin, y_position, pdf_img_width, pdf_img_height);
                        y_position += pdf_img_height + 5;
                    }

                    pdf.save(`${titulo.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);

                } catch (error) {
                    console.error("Erro ao gerar PDF:", error);
                    alert("Ocorreu um erro inesperado ao gerar o PDF. Verifique o console para mais detalhes.");
                } finally {
                    generateBtn.disabled = false;
                    loadingMessage.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
